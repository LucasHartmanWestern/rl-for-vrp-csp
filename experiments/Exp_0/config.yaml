# Created by Santiago 26/04/2024
### Configuration file with parameters to run MERL

############ Algorithm ############

algorithm_settings:
    #Currently available options DQN, CMA_optimizer, ODT 
    algorithm: 'DQN' #'ODT', #'PPO', #'DDPG' #'DQN' # 'CMA_optimizer' #
    # Decision making agent definition
    agent_by_zone: False # True if using one agent for each zone, and false using a agent for each car

federated_learning_settings:
    aggregation_count: 5 # Amount of aggregation steps for federated learning
    
    # Multipliers to control aggregation
    city_multiplier: 0.15 # Importance of city-wide average
    zone_multiplier: 0.35 # Importance of zone-wide average
    model_multiplier: 0.50 # Importance of model-wide average

############ Environment Settings ############
environment_settings:
    seed: 1234 #[1234, 5555, 2020, 5678, 9101] # Used for reproducibility
    num_of_cars: 10 #150 # Num of cars in simulation
    num_of_chargers: 2 # 3x this amount of chargers will be used (for origin, destination, and midpoint)
    action_dim: 3 # Multiplied by the number of chargers to represent how many output neurons there are for each NN

    season: 'winter' # 'spring', 'summer', 'autumn', 'winter'

    # Coordinates of city regions in London
    coords: 
        - [43.02120034946083, -81.28349087468504] # North London
        - [43.004969336049854, -81.18631870502043] # East London
#        - [42.95923445066671, -81.26016049362336] # South London
#        - [42.98111190139387, -81.30953935839466] # West London
#        - [42.9819404397449, -81.2508736429095] # Central London
    
    radius: 20 # Max radius of the circle containing the entire trip
    starting_charge: 6000 # 6kw base starting charge

    models: ['Tesla Model Y', 'BYD Song', 'Tesla Model 3'] # The 3 most popular EV models
    usage_per_hour: [9840, 8460, 9360] # Average usage per hour for each model in Wh/60 km
    max_charge: [170000, 90000, 170000] # in Watts
    step_size: 0.01  # 60km per hour / 60 minutes per hour = 1 km per minute
    increase_rate: 12500 
    max_sim_steps: 50
    max_mini_sim_steps: 10


############ Evaluation Settings ############
eval_config:
    # Determine if agent or baseline is used
    # fixed_attributes = [0.5, 0.5] # Assign fixed attributes to compare a baseline [Traffic_mult, Distance_mult]
    fixed_attributes: [] # Determine impact ratings through training
    verbose: True # Log episode-specific data during training
    display_training_times: False # Display breakdown of how much each step takes

    evaluate_on_diff_seed: False # Set to true to evaluate a model on a different seed than it was trained on
    evaluate_on_diff_zone: False # Set to true to evaluate a model on a different zone than it was trained on
        
    save_data: True # Set to true if you want to save simulation results in a csv file
    save_offline_data: False # Set true to save trajectories for offline training
    generate_plots: False # Set to true if you want to generate plots of the simulation environments
    save_aggregate_rewards: False # Set to true if you want to save the rewards across aggregations
    continue_training: False # Set to true if you want the option to continue training after a full training loop completes

    #path to store data from experiments
    save_path_metrics: '../../../storage_1/metrics/Exp'

############ Hyperparameters ############
nn_hyperparameters:
    num_episodes: 30 # Amount of training episodes per session
    learning_rate: 0.00001 # Rate of change for model parameters
    epsilon: 1 # Introduce noise during training
    discount_factor: 0.999 # Present value of future rewards
    epsilon_decay: 0.999 # Rate of decrease for training noise
    batch_size: 10 # Amount of experiences to use when training
    buffer_limit: 15 # Max number of experiences to store in a buffer
    max_num_timesteps: 300 # Max amount of minutes per agent episode
    layers: [128, 64, 64] # Neural network hidden layers

    eps_per_save: 200 # How many episodes can go by before saving

    log_std_decay_rate: 0.01 # Rate of decay for the log std of the action distribution
    num_epochs: 10 # Amount of epochs to train the neural network

    # Multipliers to control aggregation
    city_multiplier: 0.15 # Importance of city-wide average
    zone_multiplier: 0.35 # Importance of zone-wide average
    model_multiplier: 0.50 # Importance of model-wide average

############ CMA Settings ############
cma_parameters:
    population_dimension: 20
    initial_sigma: 0.1
    max_generations: 50 # Amount of training episodes per session
    #submodel inside cma agent
    model_type: 'optimizer'

############ ODT Hyperparameters ############
odt_hyperparameters:
    #ODT Configurations Offline
    # env: 'hopper'
    # dataset: '1234-15-3-2-25-20240813_163205'
    # mode: 'normal'
    # K: 20
    # pct_traj: 1.0
    # batch_size: 256
    # model_type: 'dt'
    # embed_dim: 512
    # n_layer: 4
    # n_head: 4
    # activation_function: 'relu'
    # dropout: 0.1
    # learning_rate: 0.0001
    # weight_decay: 0.0005
    # warmup_steps: 10000
    # num_eval_episodes: 50
    # max_iters: 5
    # num_steps_per_iter: 1000
    # device: 'cuda:1'
    # log_to_wandb: False
    # save_model: False
    # pretrained_model: False
    # stochastic: True
    # use_entropy: False
    # use_action_means: True
    # online_training: False
    # online_buffer_size: 1000
    # eval_only: False
    # remove_pos_embs: True
    # eval_context: 5
    # target_entropy: False
    # stochastic_tanh: True
    # approximate_entropy_samples: 1000
    # zone_index: 1 #Second zone

    # ODT Configurations Online
    env: 'hopper'
    dataset: '[10seeds]-100-3-3-100-North-East'
    mode: 'normal'
    K: 10
    pct_traj: 1.0
    batch_size: 256
    model_type: 'dt'
    embed_dim: 128
    n_layer: 3
    n_head: 1
    activation_function: 'relu'
    dropout: 0.1
    learning_rate: 0.0001
    weight_decay: 0.0001
    warmup_steps: 10000
    num_eval_episodes: 1
    max_iters: 2
    num_steps_per_iter: 300
    device: 'cuda:1'
    log_to_wandb: True
    save_model: False
    pretrained_model: '/storage_1/epigou_storage/offline_networks/dt_0[10seeds]-100-3-3-100-North-East-620076.pt'
    stochastic: True
    use_entropy: False
    use_action_means: True
    online_training: True
    online_buffer_size: 1001
    eval_only: False
    remove_pos_embs: False
    eval_context: 5
    target_entropy: True
    stochastic_tanh: True
    approximate_entropy_samples: 1000
    zone_index: 1 #Second zone